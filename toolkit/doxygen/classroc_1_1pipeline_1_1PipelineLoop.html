<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Roc Toolkit internal modules: roc::pipeline::PipelineLoop Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script src="/analytics.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="icon80.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Roc Toolkit internal modules
   </div>
   <div id="projectbrief">Roc Toolkit: real-time audio streaming</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('classroc_1_1pipeline_1_1PipelineLoop.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pro-methods">Protected Member Functions</a> &#124;
<a href="classroc_1_1pipeline_1_1PipelineLoop-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">roc::pipeline::PipelineLoop Class Reference<span class="mlabels"><span class="mlabel">abstract</span></span></div>  </div>
</div><!--header-->
<div class="contents">

<p>Base class for task-based pipelines.  
 <a href="classroc_1_1pipeline_1_1PipelineLoop.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="pipeline__loop_8h_source.html">pipeline_loop.h</a>&gt;</code></p>
<div class="dynheader">
Inheritance diagram for roc::pipeline::PipelineLoop:</div>
<div class="dyncontent">
<div class="center"><img src="classroc_1_1pipeline_1_1PipelineLoop__inherit__graph.png" border="0" usemap="#aroc_1_1pipeline_1_1PipelineLoop_inherit__map" alt="Inheritance graph"/></div>
<map name="aroc_1_1pipeline_1_1PipelineLoop_inherit__map" id="aroc_1_1pipeline_1_1PipelineLoop_inherit__map">
<area shape="rect" title="Base class for task&#45;based pipelines." alt="" coords="116,80,309,107"/>
<area shape="rect" href="classroc_1_1pipeline_1_1ReceiverLoop.html" title="Receiver pipeline loop." alt="" coords="5,155,204,181"/>
<area shape="rect" href="classroc_1_1pipeline_1_1SenderLoop.html" title="Sender pipeline loop." alt="" coords="229,155,415,181"/>
<area shape="rect" href="classroc_1_1core_1_1NonCopyable.html" title="Base class for non&#45;copyable objects." alt="" coords="107,5,318,32"/>
</map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for roc::pipeline::PipelineLoop:</div>
<div class="dyncontent">
<div class="center"><img src="classroc_1_1pipeline_1_1PipelineLoop__coll__graph.png" border="0" usemap="#aroc_1_1pipeline_1_1PipelineLoop_coll__map" alt="Collaboration graph"/></div>
<map name="aroc_1_1pipeline_1_1PipelineLoop_coll__map" id="aroc_1_1pipeline_1_1PipelineLoop_coll__map">
<area shape="rect" title="Base class for task&#45;based pipelines." alt="" coords="14,80,207,107"/>
<area shape="rect" href="classroc_1_1core_1_1NonCopyable.html" title="Base class for non&#45;copyable objects." alt="" coords="5,5,216,32"/>
</map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structroc_1_1pipeline_1_1PipelineLoop_1_1Stats.html">Stats</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Task processing statistics.  <a href="structroc_1_1pipeline_1_1PipelineLoop_1_1Stats.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a275743c9487e3502916e53e6be435d53"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#a275743c9487e3502916e53e6be435d53">schedule</a> (<a class="el" href="classroc_1_1pipeline_1_1PipelineTask.html">PipelineTask</a> &amp;task, <a class="el" href="classroc_1_1pipeline_1_1IPipelineTaskCompleter.html">IPipelineTaskCompleter</a> &amp;completer)</td></tr>
<tr class="memdesc:a275743c9487e3502916e53e6be435d53"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enqueue a task for asynchronous execution.  <a href="classroc_1_1pipeline_1_1PipelineLoop.html#a275743c9487e3502916e53e6be435d53">More...</a><br /></td></tr>
<tr class="separator:a275743c9487e3502916e53e6be435d53"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af4226854ca64421aa78669c008367888"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#af4226854ca64421aa78669c008367888">schedule_and_wait</a> (<a class="el" href="classroc_1_1pipeline_1_1PipelineTask.html">PipelineTask</a> &amp;task)</td></tr>
<tr class="memdesc:af4226854ca64421aa78669c008367888"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enqueue a task for asynchronous execution and wait until it finishes.  <a href="classroc_1_1pipeline_1_1PipelineLoop.html#af4226854ca64421aa78669c008367888">More...</a><br /></td></tr>
<tr class="separator:af4226854ca64421aa78669c008367888"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaf3ae839aa5d9c4961db972bcaa4961e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#aaf3ae839aa5d9c4961db972bcaa4961e">process_tasks</a> ()</td></tr>
<tr class="memdesc:aaf3ae839aa5d9c4961db972bcaa4961e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Process some of the enqueued tasks, if any.  <a href="classroc_1_1pipeline_1_1PipelineLoop.html#aaf3ae839aa5d9c4961db972bcaa4961e">More...</a><br /></td></tr>
<tr class="separator:aaf3ae839aa5d9c4961db972bcaa4961e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pro-methods"></a>
Protected Member Functions</h2></td></tr>
<tr class="memitem:a8e1efcb4bd789f4d739f6eb519051821"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#a8e1efcb4bd789f4d739f6eb519051821">PipelineLoop</a> (<a class="el" href="classroc_1_1pipeline_1_1IPipelineTaskScheduler.html">IPipelineTaskScheduler</a> &amp;scheduler, const <a class="el" href="structroc_1_1pipeline_1_1TaskConfig.html">TaskConfig</a> &amp;config, const <a class="el" href="classroc_1_1audio_1_1SampleSpec.html">audio::SampleSpec</a> &amp;sample_spec)</td></tr>
<tr class="memdesc:a8e1efcb4bd789f4d739f6eb519051821"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialization.  <a href="classroc_1_1pipeline_1_1PipelineLoop.html#a8e1efcb4bd789f4d739f6eb519051821">More...</a><br /></td></tr>
<tr class="separator:a8e1efcb4bd789f4d739f6eb519051821"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aae53a5a849705b6b2067358b34bc0db8"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#aae53a5a849705b6b2067358b34bc0db8">num_pending_tasks</a> () const</td></tr>
<tr class="memdesc:aae53a5a849705b6b2067358b34bc0db8"><td class="mdescLeft">&#160;</td><td class="mdescRight">How much pending tasks are there.  <a href="classroc_1_1pipeline_1_1PipelineLoop.html#aae53a5a849705b6b2067358b34bc0db8">More...</a><br /></td></tr>
<tr class="separator:aae53a5a849705b6b2067358b34bc0db8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a11639db0f8b9a2015f3a3498f9b1a8eb"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#a11639db0f8b9a2015f3a3498f9b1a8eb">num_pending_frames</a> () const</td></tr>
<tr class="memdesc:a11639db0f8b9a2015f3a3498f9b1a8eb"><td class="mdescLeft">&#160;</td><td class="mdescRight">How much pending frames are there.  <a href="classroc_1_1pipeline_1_1PipelineLoop.html#a11639db0f8b9a2015f3a3498f9b1a8eb">More...</a><br /></td></tr>
<tr class="separator:a11639db0f8b9a2015f3a3498f9b1a8eb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab78fcd544fd76d67d00dfb7898f0fbe1"><td class="memItemLeft" align="right" valign="top">const <a class="el" href="structroc_1_1pipeline_1_1PipelineLoop_1_1Stats.html">Stats</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#ab78fcd544fd76d67d00dfb7898f0fbe1">get_stats_ref</a> () const</td></tr>
<tr class="memdesc:ab78fcd544fd76d67d00dfb7898f0fbe1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get task processing statistics. Returned object can't be accessed concurrently with other methods.  <a href="classroc_1_1pipeline_1_1PipelineLoop.html#ab78fcd544fd76d67d00dfb7898f0fbe1">More...</a><br /></td></tr>
<tr class="separator:ab78fcd544fd76d67d00dfb7898f0fbe1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac642e8f64d335663fac1dcd733ea8890"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#ac642e8f64d335663fac1dcd733ea8890">process_subframes_and_tasks</a> (<a class="el" href="classroc_1_1audio_1_1Frame.html">audio::Frame</a> &amp;frame)</td></tr>
<tr class="memdesc:ac642e8f64d335663fac1dcd733ea8890"><td class="mdescLeft">&#160;</td><td class="mdescRight">Split frame and process subframes and some of the enqueued tasks.  <a href="classroc_1_1pipeline_1_1PipelineLoop.html#ac642e8f64d335663fac1dcd733ea8890">More...</a><br /></td></tr>
<tr class="separator:ac642e8f64d335663fac1dcd733ea8890"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a201a01df2f92149f6f7ff13c5074b4c1"><td class="memItemLeft" align="right" valign="top">virtual <a class="el" href="namespaceroc_1_1core.html#ae97845bc2af55cb259b19da6a128d409">core::nanoseconds_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#a201a01df2f92149f6f7ff13c5074b4c1">timestamp_imp</a> () const =0</td></tr>
<tr class="memdesc:a201a01df2f92149f6f7ff13c5074b4c1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get current time.  <a href="classroc_1_1pipeline_1_1PipelineLoop.html#a201a01df2f92149f6f7ff13c5074b4c1">More...</a><br /></td></tr>
<tr class="separator:a201a01df2f92149f6f7ff13c5074b4c1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a01e50a16d491d8236302ee397aef6b1a"><td class="memItemLeft" align="right" valign="top">virtual uint64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#a01e50a16d491d8236302ee397aef6b1a">tid_imp</a> () const =0</td></tr>
<tr class="memdesc:a01e50a16d491d8236302ee397aef6b1a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get current thread id.  <a href="classroc_1_1pipeline_1_1PipelineLoop.html#a01e50a16d491d8236302ee397aef6b1a">More...</a><br /></td></tr>
<tr class="separator:a01e50a16d491d8236302ee397aef6b1a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a49815ba906ae34a32003287c396c255a"><td class="memItemLeft" align="right" valign="top">virtual bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#a49815ba906ae34a32003287c396c255a">process_subframe_imp</a> (<a class="el" href="classroc_1_1audio_1_1Frame.html">audio::Frame</a> &amp;frame)=0</td></tr>
<tr class="memdesc:a49815ba906ae34a32003287c396c255a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Process subframe.  <a href="classroc_1_1pipeline_1_1PipelineLoop.html#a49815ba906ae34a32003287c396c255a">More...</a><br /></td></tr>
<tr class="separator:a49815ba906ae34a32003287c396c255a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a305429c7590913e13edd83d4036f7e61"><td class="memItemLeft" align="right" valign="top">virtual bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#a305429c7590913e13edd83d4036f7e61">process_task_imp</a> (<a class="el" href="classroc_1_1pipeline_1_1PipelineTask.html">PipelineTask</a> &amp;task)=0</td></tr>
<tr class="memdesc:a305429c7590913e13edd83d4036f7e61"><td class="mdescLeft">&#160;</td><td class="mdescRight">Process task.  <a href="classroc_1_1pipeline_1_1PipelineLoop.html#a305429c7590913e13edd83d4036f7e61">More...</a><br /></td></tr>
<tr class="separator:a305429c7590913e13edd83d4036f7e61"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Base class for task-based pipelines. </p>
<h2><a class="anchor" id="autotoc_md6"></a>
Frames, tasks, and threads</h2>
<p>The pipeline processes frames and tasks. This processing is serialized. At every moment, the pipeline is either processing a frame, processing a task, or doing nothing.</p>
<p>The pipeline does not have its own thread. Both frame and task processing happens when the user calls one of the pipeline methods, in the context of the caller thread. Methods may be called from different threads, concurrently. This complicates the implementation, but allows to have different thread layouts for different use cases.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Precise task scheduling</h2>
<p>This class implements "precise task scheduling" feature, which tries to schedule task processing intervals smartly, to prevent time collisions with frame processing and keep frame processing timings unaffected.</p>
<p>Precise task scheduling is enabled by default, but can be disabled via config. When disabled, no special scheduling is performed and frame and task processing compete each other for the exclusive access to the pipeline.</p>
<p>The sections below describe various aspects of the implementation.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Task processing time slices</h2>
<p>Tasks are processed between frames on dedicated time slices, to ensure that the task processing wont delay frame processing, which should be as close to real-time as possible.</p>
<p>If frame is too large, it's split into sub-frames, to allow task processing between these sub-frames. This is needed to ensure that the task processing delay would not be too large, at least while there are not too much tasks.</p>
<p>If frames are too small, tasks are processing only after some of the frames instead of after every frame. This is needed to reduce task processing overhead when using tiny frames.</p>
<p>There are two types of time slices dedicated for task processing:</p><ul>
<li>in-frame task processing: short intervals between sub-frames (inside process_frame_and_tasks())</li>
<li>inter-frame longer intervals between frames (inside <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#aaf3ae839aa5d9c4961db972bcaa4961e" title="Process some of the enqueued tasks, if any.">process_tasks()</a>)</li>
</ul>
<p>process_frame_and_tasks() calls are to be driven by the user-defined pipeline clock. It should be called exactly when it's time to process more samples. Our goal is to provide it exclusive access to the pipeline as fast as possible immediately after it's called.</p>
<p><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#aaf3ae839aa5d9c4961db972bcaa4961e" title="Process some of the enqueued tasks, if any.">process_tasks()</a> should be called by user when there are pending tasks that should be processed and when no concurrent process_frame_and_tasks() call is running. Our goal is to notify the user if and when it should be called.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Asynchronous task processing</h2>
<p>Since pipeline does not have its own thread, it can't schedule <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#aaf3ae839aa5d9c4961db972bcaa4961e" title="Process some of the enqueued tasks, if any.">process_tasks()</a> invocation by its own. Instead, it relies on the user-provided <a class="el" href="classroc_1_1pipeline_1_1IPipelineTaskScheduler.html" title="Pipeline task scheduler interface. PipelineLoop uses this interface to schedule asynchronous work....">IPipelineTaskScheduler</a> object.</p>
<p>When the pipeline wants to schedule asychronous <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#aaf3ae839aa5d9c4961db972bcaa4961e" title="Process some of the enqueued tasks, if any.">process_tasks()</a> invocation, it calls <a class="el" href="classroc_1_1pipeline_1_1IPipelineTaskScheduler.html#a933a6ab5826e0b0b3ffa250618e63854" title="Schedule asynchronous work.">IPipelineTaskScheduler::schedule_task_processing()</a>. It's up to the user when and on which thread to invoke <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#aaf3ae839aa5d9c4961db972bcaa4961e" title="Process some of the enqueued tasks, if any.">process_tasks()</a>, but pipeline gives a hint with the ideal invocation time.</p>
<p>The pipeline may also cancel the scheduled task processing by invoking <a class="el" href="classroc_1_1pipeline_1_1IPipelineTaskScheduler.html#aed22056174fad176c06f08fb697e6d99" title="Cancel previously scheduled asynchronous work.">IPipelineTaskScheduler::cancel_task_processing()</a>.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
In-place task processing</h2>
<p>If <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#a275743c9487e3502916e53e6be435d53" title="Enqueue a task for asynchronous execution.">schedule()</a> or <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#af4226854ca64421aa78669c008367888" title="Enqueue a task for asynchronous execution and wait until it finishes.">schedule_and_wait()</a> is called when the task queue is empty and the current time point belongs to the task processing time slice, the new task is processed in-place without waiting for the next process_frame_and_tasks() or <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#aaf3ae839aa5d9c4961db972bcaa4961e" title="Process some of the enqueued tasks, if any.">process_tasks()</a> invocation. This allows to avoid extra delays and thread switches when possible.</p>
<h2><a class="anchor" id="autotoc_md11"></a>
Processing priority</h2>
<p>When process_frame_and_tasks() is called, it increments pending_frame_ atomic and blocks on pipeline_mutex_. The non-zero atomic indicates that a frame needs to be processed as soon as possible and other methods should give it a way.</p>
<p>When process_frame_and_tasks() is called, it also cancels any scheduled asynchronous task processing before starting processing the frame and tasks. Before exiting, process_frame_and_tasks() checks if there are still some pending tasks and if necessary, schedules asynchronous execution again.</p>
<p>When <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#aaf3ae839aa5d9c4961db972bcaa4961e" title="Process some of the enqueued tasks, if any.">process_tasks()</a> is processing asynchronous tasks, but detects that process_frame_and_tasks() was invoked concurrently from another thread, it gives it a way and exits. process_frame_and_tasks() will process the frame and some of the remaning tasks, and if there are even more tasks remaining, it will invoke schedule_task_processing() to allow <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#aaf3ae839aa5d9c4961db972bcaa4961e" title="Process some of the enqueued tasks, if any.">process_tasks()</a> to continue.</p>
<p>When <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#a275743c9487e3502916e53e6be435d53" title="Enqueue a task for asynchronous execution.">schedule()</a> and <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#aaf3ae839aa5d9c4961db972bcaa4961e" title="Process some of the enqueued tasks, if any.">process_tasks()</a> want to invoke schedule_task_processing(), but detect that process_frame_and_tasks() was invoked concurrently from another thread, they give it a way and don't call schedule_task_processing(), assuming that process_frame_and_tasks() will either process all tasks or call schedule_task_processing() by itself.</p>
<h2><a class="anchor" id="autotoc_md12"></a>
Locking rules</h2>
<p>pipeline_mutex_ protects the internal pipeline state. It should be acquired to process a frame or a task.</p>
<p>scheduler_mutex_ protects <a class="el" href="classroc_1_1pipeline_1_1IPipelineTaskScheduler.html" title="Pipeline task scheduler interface. PipelineLoop uses this interface to schedule asynchronous work....">IPipelineTaskScheduler</a> invocations. It should be acquired to schedule or cancel asycnrhonous task processing.</p>
<p>If pipeline_mutex_ is locked, it's guaranteed that the thread locking it will check pending tasks after unlocking the mutex and will either process them or scheduler asynchronous processing.</p>
<p>If scheduler_mutex_ is locked, it's guaranteed that the thread locking it will either schedule or cancel asynchronous task processing, depending on whether there are pending tasks and frames.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
Lock-free operations</h2>
<p><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#a275743c9487e3502916e53e6be435d53" title="Enqueue a task for asynchronous execution.">schedule()</a> and <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html#aaf3ae839aa5d9c4961db972bcaa4961e" title="Process some of the enqueued tasks, if any.">process_tasks()</a> methods are lock-free. Also, they're either completely wait-free or "mostly" wait-free (i.e. on the fast path), depending on the hardware architecture (see comments for <a class="el" href="classroc_1_1core_1_1MpscQueue.html" title="Thread-safe lock-free node-based intrusive multi-producer single-consumer queue.">core::MpscQueue</a>).</p>
<p>In practice it means that when running concurrently with other <a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html" title="Base class for task-based pipelines.">PipelineLoop</a> method invocations, they never block waiting for other threads, and usually even don't spin.</p>
<p>This is archived by using a lock-free queue for tasks, atomics for 32-bit counters, seqlocks for 64-bit counters (which are reduced to atomics on 64-bit CPUs), always using try_lock() for mutexes and delaying the work if the mutex can't be acquired, and using semaphores instead of condition variables for signaling (which don't require blocking on mutex, at least on modern plarforms; e.g. on glibc they're implemented using an atomic and a futex).</p>
<p>process_frame_and_tasks() is not lock-free because it has to acquire the pipeline mutex and can't delay its work. However, the precise task scheduling feature does it best to ensure that the pipeline mutex will be unlocked when process_frame_and_tasks() is invoked, thus in most cases it wont block or wait too.</p>
<p>This approach helps us with our global goal of making all inter-thread interactions mostly wait-free, so that one thread is never or almost never blocked when another thead is blocked, preempted, or busy.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Benchmarks</h2>
<p><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html" title="Base class for task-based pipelines.">PipelineLoop</a> is covered with two groups of benchmarks:</p><ul>
<li>bench_pipeline_loop_peak_load.cpp measures frame and task processing delays with or without task load and with or without precise task scheduling feature;</li>
<li>bench_pipeline_loop_contention.cpp measures scheduling times under different contention levels.</li>
</ul>
<p>You can run them using "roc-bench-pipeline" command. For further details, see comments in the source code of the benchmarks. </p>

<p class="definition">Definition at line <a class="el" href="pipeline__loop_8h_source.html#l00193">193</a> of file <a class="el" href="pipeline__loop_8h_source.html">pipeline_loop.h</a>.</p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="a8e1efcb4bd789f4d739f6eb519051821"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8e1efcb4bd789f4d739f6eb519051821">&#9670;&nbsp;</a></span>PipelineLoop()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">roc::pipeline::PipelineLoop::PipelineLoop </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classroc_1_1pipeline_1_1IPipelineTaskScheduler.html">IPipelineTaskScheduler</a> &amp;&#160;</td>
          <td class="paramname"><em>scheduler</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structroc_1_1pipeline_1_1TaskConfig.html">TaskConfig</a> &amp;&#160;</td>
          <td class="paramname"><em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="classroc_1_1audio_1_1SampleSpec.html">audio::SampleSpec</a> &amp;&#160;</td>
          <td class="paramname"><em>sample_spec</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">protected</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initialization. </p>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="ab78fcd544fd76d67d00dfb7898f0fbe1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab78fcd544fd76d67d00dfb7898f0fbe1">&#9670;&nbsp;</a></span>get_stats_ref()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="structroc_1_1pipeline_1_1PipelineLoop_1_1Stats.html">Stats</a>&amp; roc::pipeline::PipelineLoop::get_stats_ref </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">protected</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Get task processing statistics. Returned object can't be accessed concurrently with other methods. </p>

</div>
</div>
<a id="a11639db0f8b9a2015f3a3498f9b1a8eb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a11639db0f8b9a2015f3a3498f9b1a8eb">&#9670;&nbsp;</a></span>num_pending_frames()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">size_t roc::pipeline::PipelineLoop::num_pending_frames </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">protected</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>How much pending frames are there. </p>

</div>
</div>
<a id="aae53a5a849705b6b2067358b34bc0db8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aae53a5a849705b6b2067358b34bc0db8">&#9670;&nbsp;</a></span>num_pending_tasks()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">size_t roc::pipeline::PipelineLoop::num_pending_tasks </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">protected</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>How much pending tasks are there. </p>

</div>
</div>
<a id="a49815ba906ae34a32003287c396c255a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a49815ba906ae34a32003287c396c255a">&#9670;&nbsp;</a></span>process_subframe_imp()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">virtual bool roc::pipeline::PipelineLoop::process_subframe_imp </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classroc_1_1audio_1_1Frame.html">audio::Frame</a> &amp;&#160;</td>
          <td class="paramname"><em>frame</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">protected</span><span class="mlabel">pure virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Process subframe. </p>

</div>
</div>
<a id="ac642e8f64d335663fac1dcd733ea8890"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac642e8f64d335663fac1dcd733ea8890">&#9670;&nbsp;</a></span>process_subframes_and_tasks()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool roc::pipeline::PipelineLoop::process_subframes_and_tasks </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classroc_1_1audio_1_1Frame.html">audio::Frame</a> &amp;&#160;</td>
          <td class="paramname"><em>frame</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">protected</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Split frame and process subframes and some of the enqueued tasks. </p>

</div>
</div>
<a id="a305429c7590913e13edd83d4036f7e61"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a305429c7590913e13edd83d4036f7e61">&#9670;&nbsp;</a></span>process_task_imp()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">virtual bool roc::pipeline::PipelineLoop::process_task_imp </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classroc_1_1pipeline_1_1PipelineTask.html">PipelineTask</a> &amp;&#160;</td>
          <td class="paramname"><em>task</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">protected</span><span class="mlabel">pure virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Process task. </p>

</div>
</div>
<a id="aaf3ae839aa5d9c4961db972bcaa4961e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaf3ae839aa5d9c4961db972bcaa4961e">&#9670;&nbsp;</a></span>process_tasks()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void roc::pipeline::PipelineLoop::process_tasks </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Process some of the enqueued tasks, if any. </p>

</div>
</div>
<a id="a275743c9487e3502916e53e6be435d53"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a275743c9487e3502916e53e6be435d53">&#9670;&nbsp;</a></span>schedule()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void roc::pipeline::PipelineLoop::schedule </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classroc_1_1pipeline_1_1PipelineTask.html">PipelineTask</a> &amp;&#160;</td>
          <td class="paramname"><em>task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classroc_1_1pipeline_1_1IPipelineTaskCompleter.html">IPipelineTaskCompleter</a> &amp;&#160;</td>
          <td class="paramname"><em>completer</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Enqueue a task for asynchronous execution. </p>

</div>
</div>
<a id="af4226854ca64421aa78669c008367888"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af4226854ca64421aa78669c008367888">&#9670;&nbsp;</a></span>schedule_and_wait()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool roc::pipeline::PipelineLoop::schedule_and_wait </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classroc_1_1pipeline_1_1PipelineTask.html">PipelineTask</a> &amp;&#160;</td>
          <td class="paramname"><em>task</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Enqueue a task for asynchronous execution and wait until it finishes. </p>
<dl class="section return"><dt>Returns</dt><dd>false if the task fails. </dd></dl>

</div>
</div>
<a id="a01e50a16d491d8236302ee397aef6b1a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a01e50a16d491d8236302ee397aef6b1a">&#9670;&nbsp;</a></span>tid_imp()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">virtual uint64_t roc::pipeline::PipelineLoop::tid_imp </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">protected</span><span class="mlabel">pure virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Get current thread id. </p>

</div>
</div>
<a id="a201a01df2f92149f6f7ff13c5074b4c1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a201a01df2f92149f6f7ff13c5074b4c1">&#9670;&nbsp;</a></span>timestamp_imp()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">virtual <a class="el" href="namespaceroc_1_1core.html#ae97845bc2af55cb259b19da6a128d409">core::nanoseconds_t</a> roc::pipeline::PipelineLoop::timestamp_imp </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">protected</span><span class="mlabel">pure virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Get current time. </p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>roc_pipeline/<a class="el" href="pipeline__loop_8h_source.html">pipeline_loop.h</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespaceroc.html">roc</a></li><li class="navelem"><a class="el" href="namespaceroc_1_1pipeline.html">pipeline</a></li><li class="navelem"><a class="el" href="classroc_1_1pipeline_1_1PipelineLoop.html">PipelineLoop</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
