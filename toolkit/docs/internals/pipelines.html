<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Media pipelines &#8212; Roc Toolkit 0.3.0</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/nature.css?v=601dbdee" />
    <link rel="stylesheet" type="text/css" href="../_static/roc.css?v=37117d08" />
    <script src="../_static/documentation_options.js?v=e259d695"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/analytics.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Packets and frames" href="packets_frames.html" />
    <link rel="prev" title="Threads and queues" href="threads.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="packets_frames.html" title="Packets and frames"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="threads.html" title="Threads and queues"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Roc Toolkit 0.3.0</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../internals.html" accesskey="U">Internals</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Media pipelines</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="media-pipelines">
<h1>Media pipelines<a class="headerlink" href="#media-pipelines" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of contents:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id4">Overview</a></p></li>
<li><p><a class="reference internal" href="#pipeline-tasks" id="id5">Pipeline tasks</a></p></li>
<li><p><a class="reference internal" href="#pipeline-timing" id="id6">Pipeline timing</a></p></li>
<li><p><a class="reference internal" href="#pipeline-structure" id="id7">Pipeline structure</a></p></li>
<li><p><a class="reference internal" href="#sender-and-receiver-slots" id="id8">Sender and receiver slots</a></p></li>
<li><p><a class="reference internal" href="#sender-pipeline" id="id9">Sender pipeline</a></p></li>
<li><p><a class="reference internal" href="#sender-sub-pipelines" id="id10">Sender sub-pipelines</a></p></li>
<li><p><a class="reference internal" href="#receiver-pipeline" id="id11">Receiver pipeline</a></p></li>
<li><p><a class="reference internal" href="#receiver-sub-pipelines" id="id12">Receiver sub-pipelines</a></p></li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Overview</a><a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>Media pipelines are implemented in <code class="docutils literal notranslate"><span class="pre">roc_pipeline</span></code> module. There are two major pipeline types:</p>
<ul class="simple">
<li><p>sender pipeline, implemented in <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1SenderSink.html">SenderSink</a></p></li>
<li><p>receiver pipeline, implemented in <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1ReceiverSource.html">ReceiverSource</a></p></li>
</ul>
<p>Essentially, pipeline class constructs chain of <a class="reference internal" href="packets_frames.html"><span class="doc">packet and frame</span></a> processors from <code class="docutils literal notranslate"><span class="pre">roc_packet</span></code>, <code class="docutils literal notranslate"><span class="pre">roc_audio</span></code>, and other modules, forming a big composite processor. Sender pipeline can be seen as a processor that consumes audio frames and produces network packets. Receiver pipeline, accordingly, consumes packets and produces frames.</p>
<p>Sender and receiver pipelines implement <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1sndio_1_1ISink.html">ISink</a> and <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1sndio_1_1ISource.html">ISource</a> interfaces, respectively. Sink interface allows to write audio frames to it (sender pipeline input), and source interface allows to read audio frames from it (receiver pipeline output).</p>
<p>Except reading and writing frames, we need to be able to change pipeline configuration on fly. To achieve this, pipelines provide task-based interface for configuration operations. The foundation for task processing is implemented in <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1PipelineLoop.html">PipelineLoop</a> class, which allows to schedule tasks for execution in between frames. <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1SenderLoop.html">SenderLoop</a> and <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1ReceiverLoop.html">ReceiverLoop</a> inherit this class and provide a set of tasks suitable for configuration of corresponding pipelines.</p>
<p><code class="docutils literal notranslate"><span class="pre">SenderLoop</span></code> and <code class="docutils literal notranslate"><span class="pre">ReceiverLoop</span></code> are used by <code class="docutils literal notranslate"><span class="pre">roc_node</span></code> module. It is a top-level module that combines together <code class="docutils literal notranslate"><span class="pre">roc_pipeline</span></code> (processing), <code class="docutils literal notranslate"><span class="pre">roc_netio</span></code> (network I/O), and <code class="docutils literal notranslate"><span class="pre">roc_sndio</span></code> (sound I/O). It uses <code class="docutils literal notranslate"><span class="pre">SenderLoop</span></code> and <code class="docutils literal notranslate"><span class="pre">ReceiverLoop</span></code> to configure pipeline and to retrieve <code class="docutils literal notranslate"><span class="pre">ISink</span></code> or <code class="docutils literal notranslate"><span class="pre">ISource</span></code> (which under the hood is implemented by <code class="docutils literal notranslate"><span class="pre">SenderSink</span></code> or <code class="docutils literal notranslate"><span class="pre">ReceiverSource</span></code>). The latter is then used to transform audio frames retrieved from <code class="docutils literal notranslate"><span class="pre">roc_sndio</span></code> into network packets passed to <code class="docutils literal notranslate"><span class="pre">roc_netio</span></code>, or vice versa.</p>
<p>The diagram below demonstrates this.</p>
<a class="reference internal image-reference" href="../_images/pipeline_overview.png"><img alt="Overview" class="align-center" src="../_images/pipeline_overview.png" style="width: 780px;" /></a>
</section>
<section id="pipeline-tasks">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Pipeline tasks</a><a class="headerlink" href="#pipeline-tasks" title="Link to this heading">¶</a></h2>
<p>Pipeline configuration is done via task-based interface. When you want to change pipeline layout or options, you create a task and ask pipeline to schedule it. The task will be then executed on pipeline thread, usually before processing next frame.</p>
<p>This approach have two important advantages:</p>
<ul class="simple">
<li><p>frame processing is not interrupted or delayed by other threads; pipeline is free to decide when it’s the best time to perform configuration</p></li>
<li><p>except task queue, no other pipeline elements should be thread-safe</p></li>
</ul>
<p>For further details, see <a class="reference internal" href="threads.html"><span class="doc">Threads and queues</span></a>.</p>
</section>
<section id="pipeline-timing">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Pipeline timing</a><a class="headerlink" href="#pipeline-timing" title="Link to this heading">¶</a></h2>
<p>The key feature of pipelines is that they are passive and are clocked by their user.</p>
<p>When the user reads or writes packet or frame from the top-level pipeline element, the call is recursively propagated to inner elements. Every element tries to perform the amount of work required to advance the stream exactly by one packet or frame, or to be as close as possible to it.</p>
<p>This allows doing things in time and in the right clock domain. This is important for two reasons.</p>
<p>First, every device, including the CPU and the sound card, has its own clock domain and has a bit different frequency than all other devices, even if nominally the frequencies are configured to be the same. Therefore, the real-time stream on the sender or receiver can’t have its own CPU timer but instead should be driven in the sound card clock domain. Otherwise, the pipeline stream will eventually lag behind or ahead of the sound card stream.</p>
<p>Second, the receiver should advance the stream exactly when it’s time to pass the corresponding samples to the sound card. Advancing the stream too late will cause glitches. Advancing the stream too early can cause glitches as well because chances are that some packets are not yet received by this time and so they will be considered lost, even though they can be received a bit later but still within the acceptable latency.</p>
<p>Note that, however, if the sender or receiver works with a sound file instead of a sound card, the pipeline is clocked by a CPU timer because the sound file obviously does not have its own real-time clock.</p>
<p>Another important point is that the sender and receiver have different clock domains as well. To deal with it, there is a resampler in the receiver pipeline, which dynamically converts the sender clock domain to the receiver clock domain by adjusting the sample rate. See <a class="reference internal" href="fe_resampler.html"><span class="doc">Frequency estimator and resampler</span></a>.</p>
</section>
<section id="pipeline-structure">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Pipeline structure</a><a class="headerlink" href="#pipeline-structure" title="Link to this heading">¶</a></h2>
<p>Pipelines used in sender and receiver are chains of consecutively connected elements. Each element has a reference to the inner element (or sometimes multiple elements) and adds some pre- or post-processing on top of it.</p>
<p>The element interface depends on the pipeline type, which may be packet or frame, and pipeline direction, which may be read or write. Therefore, there are four element interfaces: packet reader, packet writer, frame reader, frame writer.</p>
<p>Some elements may implement one interface but refer to an inner element of another interface, or implement multiple interfaces. Such elements act as adapters between sub-pipelines of different types or directions.</p>
</section>
<section id="sender-and-receiver-slots">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Sender and receiver slots</a><a class="headerlink" href="#sender-and-receiver-slots" title="Link to this heading">¶</a></h2>
<p>Both sender and receiver pipeline have support for slots. Slots allow single sender or receiver to have multiple groups of endpoints, even if those endpoints use different protocols.</p>
<p>For example, on receiver you can create one slot with a single endpoint (RTP), and another slot with a pair of source and repair endpoints (RTP + Reed-Solomon FEC). Senders that support only RTP will send packets to the first slot, and senders that support FECFRAME will send packets to the second slot. A single receiver will be able to handle both types of sender.</p>
<p>Another example is to create two sender slots, connected to different receivers (probably via different protocols). This way single sender will be able to forward traffic to multiple receivers.</p>
<p>Each slot can have at most one endpoint of each type:</p>
<ul class="simple">
<li><p>source endpoint (for media packets)</p></li>
<li><p>repair endpoint (for FEC packets)</p></li>
<li><p>control endpoint (for control packets)</p></li>
</ul>
</section>
<section id="sender-pipeline">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Sender pipeline</a><a class="headerlink" href="#sender-pipeline" title="Link to this heading">¶</a></h2>
<p>The diagram below shows the structure of sender pipeline.</p>
<p>Sender pipeline is composed from several classes:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1SenderSink.html">SenderSink</a> - top-level class, represents the whole sender pipeline; contains one or several slots, and a fanout</p></li>
<li><p><a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1SenderSlot.html">SenderSlot</a> - represents one slot of the sender; contains a set of related endpoints (e.g. source, repair, and control) and one sender session</p></li>
<li><p><a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1SenderEndpoint.html">SenderEndpoint</a> - represents endpoint sub-pipeline; implements packet processing specific to endpoint</p></li>
<li><p><a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1SenderSession.html">SenderSession</a> - represents session sub-pipeline; implements the main part of sender processing</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/sender_pipeline.png"><img alt="Sender pipeline" class="align-center" src="../_images/sender_pipeline.png" style="width: 700px;" /></a>
</section>
<section id="sender-sub-pipelines">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Sender sub-pipelines</a><a class="headerlink" href="#sender-sub-pipelines" title="Link to this heading">¶</a></h2>
<p>The diagram below shows an example of the sender session and endpoint sub-pipelines.</p>
<p>Some of the elements shown can be removed from the pipeline or replaced with other elements depending on the sender configuration. For instance, resampling and FEC can be disabled completely, the specific RTP and FEC encoders can be changed, and the number and contents of the port pipelines depend on the network ports and protocols being used.</p>
<p>The sender pipeline is a writer pipeline. The sound card thread writes frames to the pipeline, and the pipeline writes packets to the network thread queue.</p>
<p>In general terms, the flow is the following:</p>
<ul class="simple">
<li><p>the sound card thread writes a frame to the pipeline;</p></li>
<li><p>the frame passes through fanout to session pipeline of each sender slot;</p></li>
<li><p>the frame passes through several frame writers;</p></li>
<li><p>the frame is split into packets;</p></li>
<li><p>the packets pass through several packet writers;</p></li>
<li><p>each packet is routed to appropriate endpoint pipeline, according to the packet stream identifier;</p></li>
<li><p>in the endpoint pipeline, packet headers and payload are composed, depending on the endpoint protocol;</p></li>
<li><p>the packets are written to the network thread queue.</p></li>
</ul>
<p>The specific functions of the individual pipeline elements are documented in <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/">Doxygen</a>.</p>
<a class="reference internal image-reference" href="../_images/sender_session_pipeline.png"><img alt="Sender session pipeline" class="align-center" src="../_images/sender_session_pipeline.png" style="width: 520px;" /></a>
</section>
<section id="receiver-pipeline">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Receiver pipeline</a><a class="headerlink" href="#receiver-pipeline" title="Link to this heading">¶</a></h2>
<p>The diagram below shows the structure of receiver pipeline.</p>
<p>Receiver pipeline is composed from several classes:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1ReceiverSource.html">ReceiverSource</a> - top-level class, represents the whole receiver pipeline; contains one or several slots, and a mixer</p></li>
<li><p><a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1ReceiverSource.html">ReceiverSlot</a> - represents one slot of the receiver; contains a set of related endpoints (e.g. source, repair, and control) and a session group</p></li>
<li><p><a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1ReceiverEndpoint.html">ReceiverEndpoint</a> - represents endpoint sub-pipeline; implements packet processing specific to endpoint</p></li>
<li><p><a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1ReceiverSessionGroup.html">ReceiverSessionGroup</a> - represents a set of sessions belonging to one slot; implements routing of packets to sessions</p></li>
<li><p><a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1ReceiverSession.html">ReceiverSession</a> - represents session sub-pipeline; created for every sender connected to receiver; implements processing specific to that session</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/receiver_pipeline.png"><img alt="Receiver pipeline" class="align-center" src="../_images/receiver_pipeline.png" style="width: 700px;" /></a>
</section>
<section id="receiver-sub-pipelines">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Receiver sub-pipelines</a><a class="headerlink" href="#receiver-sub-pipelines" title="Link to this heading">¶</a></h2>
<p>The diagram below shows an example of the receiver session and endpoint sub-pipelines.</p>
<p>Some of the elements shown can be removed from the pipeline or replaced with other elements depending on the receiver configuration. For instance, resampling and FEC can be disabled completely, the specific RTP and FEC decoders can be changed, and the number and contents of the port pipelines depend on the network ports and protocols being used.</p>
<p>The receiver pipeline is a combination of writer and reader pipelines. The network thread writes packets to the pipeline, and the sound card thread reads frames from the pipeline.</p>
<p>The flow of the write part is the following:</p>
<ul class="simple">
<li><p>packet received from the network is routed to appropriate endpoint pipeline, according to the packet destination address;</p></li>
<li><p>in the endpoint pipeline, packet headers and payload are parsed, according to the endpoint protocol;</p></li>
<li><p>packet is routed to session group of the receiver slot to which endpoint belongs;</p></li>
<li><p>packet is routed to appropriate session pipeline, according to the packet source;</p></li>
<li><p>in the session pipeline, packet is routed to a specific queue, according to the packet stream identifier;</p></li>
<li><p>the packet is stored in that queue.</p></li>
</ul>
<p>The flow of the read part is the following:</p>
<ul class="simple">
<li><p>the sound card thread requests a frame from the receiver pipeline;</p></li>
<li><p>the receiver pipeline requests a frame from mixer</p></li>
<li><p>mixer requests a frame from every session pipeline of every receiver slot;</p></li>
<li><p>the frame is requested through several frame readers;</p></li>
<li><p>the frame is being built from packets, for which the packets are requested from packet readers;</p></li>
<li><p>the packets are requested through several packet readers;</p></li>
<li><p>the packets are fetched from the queues where they were stored by the write part.</p></li>
</ul>
<p>The specific functions of the individual pipeline elements are documented in <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/">Doxygen</a>.</p>
<a class="reference internal image-reference" href="../_images/receiver_session_pipeline.png"><img alt="Receiver session pipeline" class="align-center" src="../_images/receiver_session_pipeline.png" style="width: 620px;" /></a>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo80.png" alt="Logo"/>
            </a></p>
<h3><a href="../index.html">Table of Contents</a></h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about_project.html">About project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../building.html">Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manuals.html">Manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../portability.html">Portability</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../internals.html">Internals</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="code_structure.html">Code structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="threads.html">Threads and queues</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Media pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="packets_frames.html">Packets and frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="timestamps.html">Timestamps</a></li>
<li class="toctree-l2"><a class="reference internal" href="fec.html">Forward Erasure Correction codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="fe_resampler.html">Frequency estimator and resampler</a></li>
<li class="toctree-l2"><a class="reference internal" href="network_protocols.html">Network protocols</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="packets_frames.html" title="Packets and frames"
             >next</a> |</li>
        <li class="right" >
          <a href="threads.html" title="Threads and queues"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Roc Toolkit 0.3.0</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../internals.html" >Internals</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Media pipelines</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Roc Streaming authors.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>