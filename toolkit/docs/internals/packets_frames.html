<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Packets and frames &#8212; Roc Toolkit 0.3.0</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/nature.css?v=601dbdee" />
    <link rel="stylesheet" type="text/css" href="../_static/roc.css?v=37117d08" />
    <script src="../_static/documentation_options.js?v=e259d695"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/analytics.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Timestamps" href="timestamps.html" />
    <link rel="prev" title="Media pipelines" href="pipelines.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="timestamps.html" title="Timestamps"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="pipelines.html" title="Media pipelines"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Roc Toolkit 0.3.0</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../internals.html" accesskey="U">Internals</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Packets and frames</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="packets-and-frames">
<h1>Packets and frames<a class="headerlink" href="#packets-and-frames" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of contents:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#packets" id="id5">Packets</a></p></li>
<li><p><a class="reference internal" href="#packet-lifecycle" id="id6">Packet lifecycle</a></p></li>
<li><p><a class="reference internal" href="#packet-parsers-and-composers" id="id7">Packet parsers and composers</a></p></li>
<li><p><a class="reference internal" href="#packet-types" id="id8">Packet types</a></p></li>
<li><p><a class="reference internal" href="#frames" id="id9">Frames</a></p></li>
<li><p><a class="reference internal" href="#frame-lifecycle" id="id10">Frame lifecycle</a></p></li>
</ul>
</nav>
<section id="packets">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Packets</a><a class="headerlink" href="#packets" title="Link to this heading">¶</a></h2>
<p><a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1packet_1_1Packet.html">Packet</a> class from <code class="docutils literal notranslate"><span class="pre">roc_packet</span></code> module represents incoming or outgoing packet.</p>
<p>Packet holds the following information:</p>
<ul class="simple">
<li><p><strong>data</strong> - Byte slice (<code class="docutils literal notranslate"><span class="pre">core::Slice</span></code>) that references binary data of the whole packet. <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1core_1_1Slice.html">core::Slice</a> holds s shared pointer to <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1core_1_1Buffer.html">core::Buffer</a> plus offset and length of the region inside the buffer.</p></li>
<li><p><strong>headers</strong> - Parsed protocol-specific fields. For example, <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/structroc_1_1packet_1_1UDP.html">UDP</a> struct holds UDP ports, and <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/structroc_1_1packet_1_1RTP.html">RTP</a> struct holds RTP timestamp, seqnum, and other fields. What headers are present in packet depends on packet type.</p></li>
<li><p><strong>flags</strong> - Bitmask that defines what kind of packet is this, what headers are available, and what action were already done with the packet.</p></li>
</ul>
</section>
<section id="packet-lifecycle">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Packet lifecycle</a><a class="headerlink" href="#packet-lifecycle" title="Link to this heading">¶</a></h2>
<p>Packet life cycle depends on whether we’re inside sender or receiver pipeline.</p>
<p>Typical packet <strong>lifecycle on sender</strong>:</p>
<ul class="simple">
<li><p>Allocate packet from packet pool (abstracted by <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1packet_1_1PacketFactory.html">packet factory</a>).</p></li>
</ul>
<span/><ul class="simple">
<li><p>Allocate buffer from buffer pool (abstracted by <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1core_1_1BufferFactory.html">buffer factory</a>) and attach buffer to packet.</p></li>
</ul>
<span/><ul class="simple">
<li><p>If there are specific requirements for payload alignment, ask <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1packet_1_1IComposer.html">packet composer</a> to <strong>align</strong> packet. Composer adjusts packet’s buffer in a way so that payload inside buffer would have desired alignment.</p></li>
</ul>
<span/><ul class="simple">
<li><p>Ask <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1packet_1_1IComposer.html">packet composer</a> to <strong>prepare</strong> packet. Composer resizes packet’s buffer to be able to hold given payload size and all necessary headers. Composer also enables appropriate header structs in packet (e.g. <code class="docutils literal notranslate"><span class="pre">RTP</span></code> or <code class="docutils literal notranslate"><span class="pre">FEC</span></code>) by setting appropriate packet flags.</p></li>
</ul>
<span/><ul class="simple">
<li><p>Pass packet to pipeline of chained <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1packet_1_1IWriter.html">packet writers</a>. As packet goes through the pipeline, pipeline components may populate packet with more data, i.e. set fields of packet’s header structs and encode samples directly into packet’s buffer.</p></li>
</ul>
<span/><ul class="simple">
<li><p>In the end of pipeline, ask <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1packet_1_1IComposer.html">packet composer</a> to <strong>compose</strong> packet. Composer finishes filling of packet’s buffer by encoding all fields from header structs into corresponding parts of the packet’s buffer.</p></li>
</ul>
<span/><ul class="simple">
<li><p>After the packet is composed, its buffer may be sent over network.</p></li>
</ul>
<span/><ul class="simple">
<li><p>After packet is sent, packet and packet’s buffer may be returned to pools.</p></li>
</ul>
<p>Typical packet <strong>lifecycle on receiver</strong>:</p>
<ul class="simple">
<li><p>Allocate packet from packet pool (abstracted by <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1packet_1_1PacketFactory.html">packet factory</a>).</p></li>
</ul>
<span/><ul class="simple">
<li><p>Allocate buffer from buffer pool (abstracted by <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1core_1_1BufferFactory.html">buffer factory</a>) and attach buffer to packet.</p></li>
</ul>
<span/><ul class="simple">
<li><p>Fill packet’s buffer with data retrieved from network.</p></li>
</ul>
<span/><ul class="simple">
<li><p>Ask <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1packet_1_1IParser.html">packet parser</a> to <strong>parse</strong> packet’s buffer. Parser enables appropriate header structs in packet (e.g. <code class="docutils literal notranslate"><span class="pre">RTP</span></code> or <code class="docutils literal notranslate"><span class="pre">FEC</span></code>) by setting appropriate packet flags, and fills these structs with information decoded from packet’s buffer.</p></li>
</ul>
<span/><ul class="simple">
<li><p>Pass packet to pipeline of chained <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1packet_1_1IReader.html">packet readers</a>. As packet goes through the pipeline, pipeline components may read fields of packet’s header structs and decode samples directly from packet’s buffer.</p></li>
</ul>
<span/><ul class="simple">
<li><p>After packet is not needed anymore, packet and packet’s buffer may be returned to pools.</p></li>
</ul>
<p>For further details, see <a class="reference internal" href="pipelines.html"><span class="doc">Media pipelines</span></a>.</p>
</section>
<section id="packet-parsers-and-composers">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Packet parsers and composers</a><a class="headerlink" href="#packet-parsers-and-composers" title="Link to this heading">¶</a></h2>
<p>Packet <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1packet_1_1IParser.html">parser</a> and <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1packet_1_1IComposer.html">composer</a> are interfaces that have implementations for various protocols, e.g. RTP or FECFRAME.</p>
<p>Both parsers and composers can be <strong>chained</strong> to implement stacking of protocols. For example, depending on FEC scheme, FECFRAME may require adding a footer to source packets. When such FEC scheme is used, pipeline will create two chained parsers/composers: the first one for FECFRAME protocol, and the second, nested one, for RTP protocol.</p>
<p>The chaining support is based on <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1core_1_1Slice.html">slices</a>. Packet’s data field contains a slice that refers to a part of a buffer. When chaining is employed, the upper parser/composer creates a sub-slice of packet’s buffer which corresponds to the nested protocol, and passes that sub-slice to the nested parser/composer. This way parser or composer does not need to be aware of whether it’s the upper one or nested one.</p>
<p>Slices are also used in composer for payload alignment. Some pipeline components may have specific requirements for payload, for example, OpenFEC codec requires payload to be 8-byte aligned. To achieve this, FEC composer may sub-slice initial packet’s buffer to shift its beginning in a way that after adding all headers, payload becomes properly aligned.</p>
</section>
<section id="packet-types">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Packet types</a><a class="headerlink" href="#packet-types" title="Link to this heading">¶</a></h2>
<p>There are three major types of packets:</p>
<ul>
<li><p><strong>source packets</strong> – Packets with encoded media data.</p>
<p>Always present. When FEC is enabled, may also contain FEC-specific header or footer.</p>
</li>
<li><p><strong>repair packets</strong> – Packets with encoded redundancy data.</p>
<p>Present only when FEC is enabled. Format depends on FEC scheme. Used to restore lost source (media) packets on receiver.</p>
</li>
<li><p><strong>control packets</strong> – Out-of-band control messages.</p>
<p>Present unless disabled by user. May be used for session management, congestion control, latency estimation, synchronization, etc.</p>
</li>
</ul>
<p>Typical examples are RTP for source packets, FECFRAME for repair packets, and RTCP for control packets. See <a class="reference internal" href="network_protocols.html"><span class="doc">Network protocols</span></a> page for the list of supported protocols.</p>
<p>For further details about FECFRAME and RTCP usage, see <a class="reference internal" href="fec.html"><span class="doc">Forward Erasure Correction codes</span></a> and <a class="reference internal" href="timestamps.html"><span class="doc">Timestamps</span></a>.</p>
</section>
<section id="frames">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Frames</a><a class="headerlink" href="#frames" title="Link to this heading">¶</a></h2>
<p><a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1audio_1_1Frame.html">Frame</a> class from <code class="docutils literal notranslate"><span class="pre">roc_audio</span></code> module represents input or output audio frame.</p>
<ul class="simple">
<li><p><strong>samples</strong> - Pointer to audio samples array and its length.</p></li>
<li><p><strong>flags</strong> - Bitmask that defines what additional information about the frame.</p></li>
</ul>
<p>Unlike packet, a frame does not hold ownership of the samples array (packet holds a shared pointer to buffer). Frames are typically short-living objects allocated on stack and existing only during single pipeline tick.</p>
</section>
<section id="frame-lifecycle">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Frame lifecycle</a><a class="headerlink" href="#frame-lifecycle" title="Link to this heading">¶</a></h2>
<p>Frame life cycle depends on whether we’re inside sender or receiver pipeline.</p>
<p>Typical frame <strong>lifecycle on sender</strong>:</p>
<ul class="simple">
<li><p>Allocate frame on stack and attach to some samples array.</p></li>
</ul>
<span/><ul class="simple">
<li><p>Pass frame to pipeline of chained <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1audio_1_1IFrameWriter.html">frame writers</a>, requesting to process samples from this frame. A writer may pass the same frame further, or may create a new frame based on the provided one.</p></li>
</ul>
<span/><ul class="simple">
<li><p>Eventually, <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1audio_1_1Packetizer.html">packetizer</a> produces packet(s) based on the frame, and the remainder of the pipeline will pass packets.</p></li>
</ul>
<p>Typical frame <strong>lifecycle on receiver</strong>:</p>
<ul class="simple">
<li><p>Allocate frame on stack and attach to some samples array.</p></li>
</ul>
<span/><ul class="simple">
<li><p>Pass frame to pipeline of chained <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1audio_1_1IFrameReader.html">frame reader</a>, requesting to fill this frame with samples. A reader may pass the same frame further, or may create a new frame, request subsequent reader(s) to fill it, and then fill the provided frame based on that.</p></li>
</ul>
<span/><ul class="simple">
<li><p>Eventually, the request reaches <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1audio_1_1Depacketizer.html">depacketizer</a>, which consumes packet(s) from incoming queue and decodes them into the frame.</p></li>
</ul>
<p>For further details, see <a class="reference internal" href="pipelines.html"><span class="doc">Media pipelines</span></a>.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo80.png" alt="Logo"/>
            </a></p>
<h3><a href="../index.html">Table of Contents</a></h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about_project.html">About project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../building.html">Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manuals.html">Manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../portability.html">Portability</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../internals.html">Internals</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="code_structure.html">Code structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="threads.html">Threads and queues</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipelines.html">Media pipelines</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Packets and frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="timestamps.html">Timestamps</a></li>
<li class="toctree-l2"><a class="reference internal" href="fec.html">Forward Erasure Correction codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="fe_resampler.html">Frequency estimator and resampler</a></li>
<li class="toctree-l2"><a class="reference internal" href="network_protocols.html">Network protocols</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="timestamps.html" title="Timestamps"
             >next</a> |</li>
        <li class="right" >
          <a href="pipelines.html" title="Media pipelines"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Roc Toolkit 0.3.0</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../internals.html" >Internals</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Packets and frames</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Roc Streaming authors.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>