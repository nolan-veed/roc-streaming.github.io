<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Threads and queues &#8212; Roc Toolkit 0.3.0</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/nature.css?v=601dbdee" />
    <link rel="stylesheet" type="text/css" href="../_static/roc.css?v=37117d08" />
    <script src="../_static/documentation_options.js?v=e259d695"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/analytics.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Media pipelines" href="pipelines.html" />
    <link rel="prev" title="Code structure" href="code_structure.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="pipelines.html" title="Media pipelines"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="code_structure.html" title="Code structure"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Roc Toolkit 0.3.0</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../internals.html" accesskey="U">Internals</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Threads and queues</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="threads-and-queues">
<h1>Threads and queues<a class="headerlink" href="#threads-and-queues" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of contents:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#threads" id="id1">Threads</a></p></li>
<li><p><a class="reference internal" href="#queues" id="id2">Queues</a></p></li>
<li><p><a class="reference internal" href="#tasks" id="id3">Tasks</a></p></li>
</ul>
</nav>
<section id="threads">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Threads</a><a class="headerlink" href="#threads" title="Link to this heading">¶</a></h2>
<p>Roc nodes (senders and receivers) typically employ several threads.</p>
<ul>
<li><p><strong>Network I/O thread</strong></p>
<p>Network event loop thread. Sends packets from outgoing queue. Receives packets and stores into incoming queue.</p>
<p>Implemented by <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1netio_1_1NetworkLoop.html">NetworkLoop</a> class from <code class="docutils literal notranslate"><span class="pre">roc_netio</span></code> module.</p>
</li>
<li><p><strong>Sound I/O thread</strong></p>
<p>Audio input or output thread. Sends audio frames to sound card, or receives frames from it.</p>
<p>Implemented by <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1sndio_1_1ISink.html">sinks</a> and <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1sndio_1_1ISource.html">sources</a> from <code class="docutils literal notranslate"><span class="pre">roc_sndio</span></code> module.</p>
</li>
<li><p><strong>Pipeline thread</strong></p>
<p>Processing thread. Converts a stream of network packets into a stream of audio frames (on receiver), or vice versa (on sender).</p>
<p>Implemented by <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1pipeline_1_1PipelineLoop.html">PipelineLoop</a> and its derived classes from <code class="docutils literal notranslate"><span class="pre">roc_pipeline</span></code> module.</p>
</li>
<li><p><strong>Control thread</strong></p>
<p>Control task event loop. Executes asynchronous tasks for signaling protocols and background work.</p>
<p>Implemented by <a class="reference external" href="https://roc-streaming.org/toolkit/doxygen/classroc_1_1ctl_1_1ControlLoop.html">ControlLoop</a> class from <code class="docutils literal notranslate"><span class="pre">roc_ctl</span></code> module.</p>
</li>
</ul>
<p>Depending on sound system in use, sound I/O thread and pipeline thread may be the same thread. For example, on ALSA a single thread perform audio I/O and processing, and on PulseAudio, there are separate threads for I/O and processing.</p>
<p>When the user uses <code class="docutils literal notranslate"><span class="pre">roc_sender</span></code> or <code class="docutils literal notranslate"><span class="pre">roc_receiver</span></code> from the <a class="reference internal" href="../api/reference.html"><span class="doc">C library</span></a>, Roc does not manage sound I/O. It also does not create dedicated pipeline thread - instead, the user invokes pipeline processing on their own thread.</p>
<p>Network and control threads belong to context. Sound I/O and pipeline threads, in contrast, belong to node (sender or receiver). When multiple nodes share a single context, they, among other things, share network and control threads as well. The user is free to decide whether to use one context for everything or create an individual context for each node.</p>
</section>
<section id="queues">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Queues</a><a class="headerlink" href="#queues" title="Link to this heading">¶</a></h2>
<p>Threads in Roc typically don’t have a lot of shared state. They are very isolated and communicate only via packet and task queues. With this approach, most components do not have to bother with synchronization.</p>
<p>The queues between threads are usually lock-free and on some platforms also wait-free, which helps to avoid priority inversion problems (when real-time or high-priority thread is blocked or delayed by low-priority threads).</p>
<p>For example, pipeline thread can enqueue a packet for sending on network thread, or schedule a task for execution on control thread, without a risk of being blocked by network and control threads. This is essential to avoid glitches and maintain low latency.</p>
<p>The diagram below illustrates major threads and connections between them.</p>
<a class="reference internal image-reference" href="../_images/queues.png"><img alt="Queues" class="align-center" src="../_images/queues.png" style="width: 780px;" /></a>
</section>
<section id="tasks">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Tasks</a><a class="headerlink" href="#tasks" title="Link to this heading">¶</a></h2>
<p>Network thread, pipeline thread, and control thread, all provide task-based interface to perform control and configuration operations.</p>
<p>For example, when we want network thread to bind a port, or pipeline thread to create an endpoint, we should allocate a corresponding task object and schedule it for execution on relevant thread. We can then wait until task is complete, or register a completion callback.</p>
<p>While all these threads provide similar task-based interface, the underlying implementation is different:</p>
<ul class="simple">
<li><p>network thread runs an event loop, and supports multiplexing socket I/O and execution of tasks</p></li>
<li><p>pipeline thread runs processing loop, and is capable of running tasks during gaps between frames, to ensure that execution of tasks wont introduce processing delays and glitches</p></li>
<li><p>control thread is dedicated entirely for task processing and implements advanced interfaces like scheduling tasks with specific deadline, canceling tasks, pausing and resuming tasks, etc.</p></li>
</ul>
<p>The allocation and deallocation of a task is responsibility of the caller. For each public operation, there is a task class defined. The caller should create an instance of that class, set its parameters, and schedule the task. The caller is responsible to ensure that the task is alive until completion callback is invoked.</p>
<p>This approach allows to make task scheduling zero-copy and zero-allocation in most cases. Typically the task object can be embedded into a larger owner object, e.g. control task may be embedded into control endpoint object that needs this task.</p>
<p>Given that task queues are based on intrusive containers (e.g. lists and heaps), enqueuing a pre-allocated task does not require making any allocations or copies and is very cheap. This as well helps to keep scheduling operations lock-free.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo80.png" alt="Logo"/>
            </a></p>
<h3><a href="../index.html">Table of Contents</a></h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about_project.html">About project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../building.html">Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manuals.html">Manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../portability.html">Portability</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../internals.html">Internals</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="code_structure.html">Code structure</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Threads and queues</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipelines.html">Media pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="packets_frames.html">Packets and frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="timestamps.html">Timestamps</a></li>
<li class="toctree-l2"><a class="reference internal" href="fec.html">Forward Erasure Correction codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="fe_resampler.html">Frequency estimator and resampler</a></li>
<li class="toctree-l2"><a class="reference internal" href="network_protocols.html">Network protocols</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="pipelines.html" title="Media pipelines"
             >next</a> |</li>
        <li class="right" >
          <a href="code_structure.html" title="Code structure"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Roc Toolkit 0.3.0</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../internals.html" >Internals</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Threads and queues</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Roc Streaming authors.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>