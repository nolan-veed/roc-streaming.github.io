<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Android environment &#8212; Roc Toolkit 0.3.0</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/nature.css?v=601dbdee" />
    <link rel="stylesheet" type="text/css" href="../_static/roc.css?v=37117d08" />
    <script src="../_static/documentation_options.js?v=e259d695"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/analytics.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Internals" href="../internals.html" />
    <link rel="prev" title="Cross-compiling" href="cross_compiling.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../internals.html" title="Internals"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="cross_compiling.html" title="Cross-compiling"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Roc Toolkit 0.3.0</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../portability.html" accesskey="U">Portability</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Android environment</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="android-environment">
<h1>Android environment<a class="headerlink" href="#android-environment" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of contents:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#docker-image" id="id1">Docker image</a></p></li>
<li><p><a class="reference internal" href="#tools-caching" id="id2">Tools caching</a></p></li>
<li><p><a class="reference internal" href="#emulator" id="id3">Emulator</a></p></li>
<li><p><a class="reference internal" href="#device-script" id="id4">Device script</a></p></li>
</ul>
</nav>
<section id="docker-image">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Docker image</a><a class="headerlink" href="#docker-image" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">rocstreaming/env-android</span></code> image provide a full android environment for Android build and tests. It is used by <code class="docutils literal notranslate"><span class="pre">android_emu.sh</span></code> script described in <a class="reference internal" href="cross_compiling.html#android-docker"><span class="std std-ref">this section</span></a>, and in <a class="reference external" href="https://github.com/roc-streaming/roc-java/">roc-java</a> repo.</p>
<p>In particular, the following packages are availables:</p>
<ul class="simple">
<li><p>android platforms</p></li>
<li><p>android build tools</p></li>
<li><p>android ndk</p></li>
<li><p>android cmake</p></li>
<li><p>android emulator</p></li>
<li><p>adb and platform tools</p></li>
</ul>
<p>For reducing image size and have more granularity over various tools versions, those packages are installed only when container runs, i.e. at container entrypoint.</p>
<p>The following environment variables can be passed at container run for choosing a specified version:</p>
<ul class="simple">
<li><p>API</p></li>
<li><p>BUILD_TOOLS_VERSION</p></li>
<li><p>NDK_VERSION</p></li>
<li><p>CMAKE_VERSION</p></li>
</ul>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker run -t --rm -v &quot;${PWD}:${PWD}&quot; -w &quot;${PWD}&quot; -v android-sdk:/sdk --env API=28 \
  --env NDK_VERSION=21.1.6352462 --env BUILD_TOOLS_VERSION=29.0.3 \
    rocstreaming/env-android:jdk8 \
      scons -Q --compiler=clang --host=aarch64-linux-android28 \
        --disable-soversion \
        --disable-tools \
        --disable-examples \
        --disable-tests \
        --disable-pulseaudio \
        --disable-sox \
        --build-3rdparty=libuv,openfec
</pre></div>
</div>
</section>
<section id="tools-caching">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Tools caching</a><a class="headerlink" href="#tools-caching" title="Link to this heading">¶</a></h2>
<p>If a named volume is mounted at <cite>/sdk</cite> path in the container (for example by using <cite>-v android-sdk:/sdk</cite> option), next run of the image will not install again components already installed previously.</p>
<p>If it’s needed to mount the volume to a specific host location (the host location must exist) it can be achieved by adding the following options to the docker command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">mount</span> <span class="nb">type</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span><span class="n">dst</span><span class="o">=/</span><span class="n">sdk</span><span class="p">,</span><span class="n">volume</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">local</span><span class="p">,</span><span class="n">volume</span><span class="o">-</span><span class="n">opt</span><span class="o">=</span><span class="nb">type</span><span class="o">=</span><span class="n">none</span><span class="p">,</span><span class="n">volume</span><span class="o">-</span><span class="n">opt</span><span class="o">=</span><span class="n">o</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span><span class="n">volume</span><span class="o">-</span><span class="n">opt</span><span class="o">=</span><span class="n">device</span><span class="o">=&lt;</span><span class="n">host</span><span class="o">-</span><span class="n">path</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="emulator">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Emulator</a><a class="headerlink" href="#emulator" title="Link to this heading">¶</a></h2>
<p>The android emulator can use hardware acceleration features to improve performance, sometimes drastically.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>According to <a class="reference external" href="https://developer.android.com/studio/run/emulator-acceleration">official emulator acceleration docs</a>:</p>
<p>To use VM acceleration, your development environment must meet the following requirements:</p>
<blockquote>
<div><p>SDK Tools: minimum version 17; recommended version 26.1.1 or later
AVD with an x86-based system image, available for Android 2.3.3 (API level 10) and higher</p>
<blockquote>
<div><p>Warning: AVDs that use ARM- or MIPS-based system images can’t use the VM acceleration.</p>
</div></blockquote>
</div></blockquote>
<p>In addition to the development environment requirements, your computer’s processor must support one of the following virtualization extensions technologies:</p>
<blockquote>
<div><p>Intel Virtualization Technology (VT, VT-x, vmx) extensions
AMD Virtualization (AMD-V, SVM) extensions</p>
</div></blockquote>
</div>
<p>Linux-based systems support VM acceleration through the <a class="reference external" href="https://www.linux-kvm.org/page/Main_Page">KVM software package</a>.</p>
<p>For enabling hardware acceleration run the container in privileged mode, i.e. by using <code class="docutils literal notranslate"><span class="pre">--privileged</span></code> flag.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Since CI runs jobs already on a virtual environment, if the emulator need to be run on CI, the <code class="docutils literal notranslate"><span class="pre">env-android</span></code> image must be run with <code class="docutils literal notranslate"><span class="pre">--privileged</span></code> option for allowing virtualization nesting.</p>
</div>
<p>To see if acceleration is available use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ emulator -accel-check
accel:
0
KVM (version 12) is installed and usable.
</pre></div>
</div>
<p>To create an Android Virtual Device (AVD) and run the emulator:</p>
<ul>
<li><p>download the emulator system image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ yes | sdkmanager &lt;system-image&gt;
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;system-image&gt;</span></code> is in the list offered by <code class="docutils literal notranslate"><span class="pre">sdkmanager</span> <span class="pre">--list</span></code></p>
</li>
<li><p>create the AVD:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ echo no | avdmanager create avd --name &lt;avd-name&gt; --package &lt;system-image&gt;
</pre></div>
</div>
</li>
<li><p>launch emulator (use <code class="docutils literal notranslate"><span class="pre">-accel</span> <span class="pre">on</span></code> or <code class="docutils literal notranslate"><span class="pre">-accel</span> <span class="pre">off</span></code> depending of hardware acceleration availability):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ emulator -avd &lt;avd-name&gt; -no-audio -no-boot-anim -no-window -gpu off -accel [on/off] &amp;
</pre></div>
</div>
</li>
<li><p>check the AVD status:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ adb devices
List of devices attached
emulator-xxxx device
# &quot;device&quot; indicates that boot is completed
# &quot;offline&quot; indicates that boot is still going on
</pre></div>
</div>
</li>
</ul>
</section>
<section id="device-script">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Device script</a><a class="headerlink" href="#device-script" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">env-android</span></code> image provides an helper script named <code class="docutils literal notranslate"><span class="pre">device</span></code> that takes care of creating and booting up AVDs.</p>
<ul>
<li><p>create an AVD:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ device create --api=&lt;API&gt; --image=&lt;IMAGE&gt; --arch=&lt;ARCH&gt; --name=&lt;AVD-NAME&gt;
</pre></div>
</div>
<p>The string <code class="docutils literal notranslate"><span class="pre">&quot;system-images;android-&lt;API&gt;;&lt;IMAGE&gt;;&lt;ARCH&gt;&quot;</span></code> defines the emulator system image to be installed (it must be present in the list offered by <code class="docutils literal notranslate"><span class="pre">sdkmanager</span> <span class="pre">--list</span></code>)</p>
</li>
<li><p>start device and wait until boot is completed</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ device start --name=&lt;AVD-NAME&gt;
</pre></div>
</div>
</li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo80.png" alt="Logo"/>
            </a></p>
<h3><a href="../index.html">Table of Contents</a></h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about_project.html">About project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../building.html">Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manuals.html">Manuals</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../portability.html">Portability</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="supported_platforms.html">Supported platforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="tested_devices.html">Tested devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="cross_compiling.html">Cross-compiling</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Android environment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../internals.html">Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../internals.html" title="Internals"
             >next</a> |</li>
        <li class="right" >
          <a href="cross_compiling.html" title="Cross-compiling"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Roc Toolkit 0.3.0</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../portability.html" >Portability</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Android environment</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Roc Streaming authors.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>